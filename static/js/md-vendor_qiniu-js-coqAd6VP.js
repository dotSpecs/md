import{S as ve}from"./md-vendor_spark-md5-C3ZbQyno.js";import{q as ge}from"./md-vendor_querystring-m-pM5hNd.js";var ee=function(){var r=function(n,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,i){o.__proto__=i}||function(o,i){for(var t in i)i.hasOwnProperty(t)&&(o[t]=i[t])},r(n,e)};return function(n,e){r(n,e);function o(){this.constructor=n}n.prototype=e===null?Object.create(e):(o.prototype=e.prototype,new o)}}(),d;(function(r){r.InvalidFile="InvalidFile",r.InvalidToken="InvalidToken",r.InvalidMetadata="InvalidMetadata",r.InvalidChunkSize="InvalidChunkSize",r.InvalidCustomVars="InvalidCustomVars",r.NotAvailableUploadHost="NotAvailableUploadHost",r.ReadCacheFailed="ReadCacheFailed",r.InvalidCacheData="InvalidCacheData",r.WriteCacheFailed="WriteCacheFailed",r.RemoveCacheFailed="RemoveCacheFailed",r.GetCanvasContextFailed="GetCanvasContextFailed",r.UnsupportedFileType="UnsupportedFileType",r.FileReaderReadFailed="FileReaderReadFailed",r.NotAvailableXMLHttpRequest="NotAvailableXMLHttpRequest",r.InvalidProgressEventTarget="InvalidProgressEventTarget",r.RequestError="RequestError"})(d||(d={}));var p=function(){function r(n,e){this.name=n,this.message=e,this.stack=new Error().stack}return r}(),C=function(r){ee(n,r);function n(e,o,i,t){var s=r.call(this,d.RequestError,i)||this;return s.code=e,s.reqId=o,s.isRequestError=!0,s.data=t,s}return n}(p),te=function(r){ee(n,r);function n(e,o){return o===void 0&&(o=""),r.call(this,0,o,e)||this}return n}(C),ye=function(){function r(n,e){this.runTask=n,this.limit=e,this.aborted=!1,this.queue=[],this.processing=[]}return r.prototype.enqueue=function(n){var e=this;return new Promise(function(o,i){e.queue.push({task:n,resolve:o,reject:i}),e.check()})},r.prototype.run=function(n){var e=this;this.queue=this.queue.filter(function(o){return o!==n}),this.processing.push(n),this.runTask(n.task).then(function(){e.processing=e.processing.filter(function(o){return o!==n}),n.resolve(),e.check()},function(o){return n.reject(o)})},r.prototype.check=function(){var n=this;if(!this.aborted){var e=this.processing.length,o=this.limit-e;this.queue.slice(0,o).forEach(function(i){n.run(i)})}},r.prototype.abort=function(){this.queue=[],this.aborted=!0},r}(),me=function(){var r=function(n,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,i){o.__proto__=i}||function(o,i){for(var t in i)i.hasOwnProperty(t)&&(o[t]=i[t])},r(n,e)};return function(n,e){r(n,e);function o(){this.constructor=n}n.prototype=e===null?Object.create(e):(o.prototype=e.prototype,new o)}}(),U=function(){return U=Object.assign||function(r){for(var n,e=1,o=arguments.length;e<o;e++){n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])}return r},U.apply(this,arguments)},we=function(){function r(){this.closed=!1}return r.prototype.unsubscribe=function(){this.closed||(this.closed=!0,this._unsubscribe&&this._unsubscribe())},r.prototype.add=function(n){this._unsubscribe=n},r}(),be=function(r){me(n,r);function n(e,o,i){var t=r.call(this)||this;return t.isStopped=!1,e&&typeof e=="object"?t.destination=e:t.destination=U(U(U({},e&&{next:e}),o&&{error:o}),i&&{complete:i}),t}return n.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,r.prototype.unsubscribe.call(this))},n.prototype.next=function(e){!this.isStopped&&this.destination.next&&this.destination.next(e)},n.prototype.error=function(e){!this.isStopped&&this.destination.error&&(this.isStopped=!0,this.destination.error(e))},n.prototype.complete=function(e){!this.isStopped&&this.destination.complete&&(this.isStopped=!0,this.destination.complete(e))},n}(we),_e=function(){function r(n){this._subscribe=n}return r.prototype.subscribe=function(n,e,o){var i=new be(n,e,o);return i.add(this._subscribe(i)),i},r}();function xe(r){if(r===null||typeof r>"u")return"";var n=r+"",e="",o,i,t=0;o=i=0,t=n.length;for(var s=0;s<t;s++){var u=n.charCodeAt(s),l=null;if(u<128)i++;else if(u>127&&u<2048)l=String.fromCharCode(u>>6|192,u&63|128);else if((u&63488^55296)>0)l=String.fromCharCode(u>>12|224,u>>6&63|128,u&63|128);else{if((u&64512^55296)>0)throw new RangeError("Unmatched trail surrogate at "+s);var a=n.charCodeAt(++s);if((a&64512^56320)>0)throw new RangeError("Unmatched lead surrogate at "+(s-1));u=((u&1023)<<10)+(a&1023)+65536,l=String.fromCharCode(u>>18|240,u>>12&63|128,u>>6&63|128,u&63|128)}l!==null&&(i>o&&(e+=n.slice(o,i)),e+=l,o=i=s+1)}return i>o&&(e+=n.slice(o,t)),e}function ke(r){var n=[],e=0,o=0,i=0;for(r+="";e<r.length;){o=r.charCodeAt(e)&255,i=0,o<=191?(o=o&127,i=1):o<=223?(o=o&31,i=2):o<=239?(o=o&15,i=3):(o=o&7,i=4);for(var t=1;t<i;++t)o=o<<6|r.charCodeAt(t+e)&63;i===4?(o-=65536,n.push(String.fromCharCode(55296|o>>10&1023)),n.push(String.fromCharCode(56320|o&1023))):n.push(String.fromCharCode(o)),e+=i}return n.join("")}function Ce(r){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e,o,i,t,s,u,l,a,c=0,f=0,h="",v=[];if(!r)return r;r=xe(r+"");do e=r.charCodeAt(c++),o=r.charCodeAt(c++),i=r.charCodeAt(c++),a=e<<16|o<<8|i,t=a>>18&63,s=a>>12&63,u=a>>6&63,l=a&63,v[f++]=n.charAt(t)+n.charAt(s)+n.charAt(u)+n.charAt(l);while(c<r.length);switch(h=v.join(""),r.length%3){case 1:h=h.slice(0,-2)+"==";break;case 2:h=h.slice(0,-1)+"=";break}return h}function Ie(r){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e,o,i,t,s,u,l,a,c=0,f=0,h="",v=[];if(!r)return r;r+="";do t=n.indexOf(r.charAt(c++)),s=n.indexOf(r.charAt(c++)),u=n.indexOf(r.charAt(c++)),l=n.indexOf(r.charAt(c++)),a=t<<18|s<<12|u<<6|l,e=a>>16&255,o=a>>8&255,i=a&255,u===64?v[f++]=String.fromCharCode(e):l===64?v[f++]=String.fromCharCode(e,o):v[f++]=String.fromCharCode(e,o,i);while(c<r.length);return h=v.join(""),ke(h)}function b(r){return r=Ce(r),r.replace(/\//g,"_").replace(/\+/g,"-")}function ne(r){return r=r.replace(/_/g,"/").replace(/-/g,"+"),Ie(r)}var T=function(){return T=Object.assign||function(r){for(var n,e=1,o=arguments.length;e<o;e++){n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])}return r},T.apply(this,arguments)},Se=function(r,n,e,o){function i(t){return t instanceof e?t:new e(function(s){s(t)})}return new(e||(e=Promise))(function(t,s){function u(c){try{a(o.next(c))}catch(f){s(f)}}function l(c){try{a(o.throw(c))}catch(f){s(f)}}function a(c){c.done?t(c.value):i(c.value).then(u,l)}a((o=o.apply(r,n||[])).next())})},Ue=function(r,n){var e={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},o,i,t,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(c){return l([a,c])}}function l(a){if(o)throw new TypeError("Generator is already executing.");for(;e;)try{if(o=1,i&&(t=a[0]&2?i.return:a[0]?i.throw||((t=i.return)&&t.call(i),0):i.next)&&!(t=t.call(i,a[1])).done)return t;switch(i=0,t&&(a=[a[0]&2,t.value]),a[0]){case 0:case 1:t=a;break;case 4:return e.label++,{value:a[1],done:!1};case 5:e.label++,i=a[1],a=[0];continue;case 7:a=e.ops.pop(),e.trys.pop();continue;default:if(t=e.trys,!(t=t.length>0&&t[t.length-1])&&(a[0]===6||a[0]===2)){e=0;continue}if(a[0]===3&&(!t||a[1]>t[0]&&a[1]<t[3])){e.label=a[1];break}if(a[0]===6&&e.label<t[1]){e.label=t[1],t=a;break}if(t&&e.label<t[2]){e.label=t[2],e.ops.push(a);break}t[2]&&e.ops.pop(),e.trys.pop();continue}a=n.call(r,e)}catch(c){a=[6,c],i=0}finally{o=t=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},x=Math.pow(1024,2);function Re(r,n){var e=n*x;if(e>r.size)e=r.size;else for(;r.size>e*1e4;)e*=2;for(var o=[],i=Math.ceil(r.size/e),t=0;t<i;t++){var s=r.slice(e*t,t===i-1?r.size:e*(t+1));o.push(s)}return o}function Oe(r){return Object.keys(r).every(function(n){return n.indexOf("x-qn-meta-")===0})}function ze(r){return Object.keys(r).every(function(n){return n.indexOf("x:")===0})}function Fe(r){return r.reduce(function(n,e){return n+e},0)}function Ee(r,n,e){try{localStorage.setItem(r,JSON.stringify(n))}catch{e.warn(new p(d.WriteCacheFailed,"setLocalFileInfo failed: "+r))}}function Pe(r,n,e){var o=n==null?"_":"_key_"+n+"_";return"qiniu_js_sdk_upload_file_name_"+r+o+"size_"+e}function M(r,n){try{localStorage.removeItem(r)}catch{n.warn(new p(d.RemoveCacheFailed,"removeLocalFileInfo failed. key: "+r))}}function Le(r,n){var e=null;try{e=localStorage.getItem(r)}catch{n.warn(new p(d.ReadCacheFailed,"getLocalFileInfo failed. key: "+r))}if(e==null)return null;var o=null;try{o=JSON.parse(e)}catch{M(r,n),n.warn(new p(d.InvalidCacheData,"getLocalFileInfo failed to parse. key: "+r))}return o}function O(r){var n="UpToken "+r;return{Authorization:n}}function re(r){var n=O(r);return T({"content-type":"application/octet-stream"},n)}function ie(r){var n=O(r);return T({"content-type":"application/json"},n)}function oe(){if(window.XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)return new window.ActiveXObject("Microsoft.XMLHTTP");throw new p(d.NotAvailableXMLHttpRequest,"the current environment does not support.")}function Ae(r){return Se(this,void 0,void 0,function(){var n,e;return Ue(this,function(o){switch(o.label){case 0:return[4,Te(r)];case 1:return n=o.sent(),e=new ve.ArrayBuffer,e.append(n),[2,e.end()]}})})}function Te(r){return new Promise(function(n,e){var o=new FileReader;o.onload=function(i){if(i.target){var t=i.target.result;n(t)}else e(new p(d.InvalidProgressEventTarget,"progress event target is undefined"))},o.onerror=function(){e(new p(d.FileReaderReadFailed,"fileReader read failed"))},o.readAsArrayBuffer(r)})}function m(r,n){return new Promise(function(e,o){var i=oe();if(i.open(n.method,r),n.onCreate&&n.onCreate(i),n.headers){var t=n.headers;Object.keys(t).forEach(function(s){i.setRequestHeader(s,t[s])})}i.upload.addEventListener("progress",function(s){s.lengthComputable&&n.onProgress&&n.onProgress({loaded:s.loaded,total:s.total})}),i.onreadystatechange=function(){var s=i.responseText;if(i.readyState===4){var u=i.getResponseHeader("x-reqId")||"";if(i.status===0){o(new te("network error.",u));return}if(i.status!==200){var l="xhr request failed, code: "+i.status;s&&(l+=" response: "+s);var a=void 0;try{a=JSON.parse(s)}catch{}o(new C(i.status,u,l,a));return}try{e({data:JSON.parse(s),reqId:u})}catch(c){o(c)}}},i.send(n.body)})}function qe(r){if(r&&r.match){var n=r.match(/(^https?)/);if(!n)return"";var e=n[1];return n=r.match(/^https?:\/\/([^:^/]*):(\d*)/),n?n[2]:e==="http"?"80":"443"}return""}function He(r){if(r&&r.match){var n=r.match(/^https?:\/\/([^:^/]*)/);return n?n[1]:""}return""}function z(r){if(!r)throw new p(d.InvalidToken,"invalid token.");var n=r.split(":");if(n.length===1)throw new p(d.InvalidToken,"invalid token segments.");var e=n.length>3?n[1]:n[0];if(!e)throw new p(d.InvalidToken,"missing assess key field.");var o=null;try{o=JSON.parse(ne(n[n.length-1]))}catch{throw new p(d.InvalidToken,"token parse failed.")}if(o==null)throw new p(d.InvalidToken,"putPolicy is null.");if(o.scope==null)throw new p(d.InvalidToken,"scope field is null.");var i=o.scope.split(":")[0];if(!i)throw new p(d.InvalidToken,"resolve bucketName failed.");return{assessKey:e,bucketName:i,scope:o.scope}}function De(r){var n=window.URL||window.webkitURL||window.mozURL;return n.createObjectURL(r)}var y,w={z0:"z0",z1:"z1",z2:"z2",na0:"na0",as0:"as0",cnEast2:"cn-east-2"},Me=(y={},y[w.z0]={srcUphost:["up.qiniup.com"],cdnUphost:["upload.qiniup.com"]},y[w.z1]={srcUphost:["up-z1.qiniup.com"],cdnUphost:["upload-z1.qiniup.com"]},y[w.z2]={srcUphost:["up-z2.qiniup.com"],cdnUphost:["upload-z2.qiniup.com"]},y[w.na0]={srcUphost:["up-na0.qiniup.com"],cdnUphost:["upload-na0.qiniup.com"]},y[w.as0]={srcUphost:["up-as0.qiniup.com"],cdnUphost:["upload-as0.qiniup.com"]},y[w.cnEast2]={srcUphost:["up-cn-east-2.qiniup.com"],cdnUphost:["upload-cn-east-2.qiniup.com"]},y),_=function(){return _=Object.assign||function(r){for(var n,e=1,o=arguments.length;e<o;e++){n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])}return r},_.apply(this,arguments)},ae=function(r,n,e,o){function i(t){return t instanceof e?t:new e(function(s){s(t)})}return new(e||(e=Promise))(function(t,s){function u(c){try{a(o.next(c))}catch(f){s(f)}}function l(c){try{a(o.throw(c))}catch(f){s(f)}}function a(c){c.done?t(c.value):i(c.value).then(u,l)}a((o=o.apply(r,n||[])).next())})},se=function(r,n){var e={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},o,i,t,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(c){return l([a,c])}}function l(a){if(o)throw new TypeError("Generator is already executing.");for(;e;)try{if(o=1,i&&(t=a[0]&2?i.return:a[0]?i.throw||((t=i.return)&&t.call(i),0):i.next)&&!(t=t.call(i,a[1])).done)return t;switch(i=0,t&&(a=[a[0]&2,t.value]),a[0]){case 0:case 1:t=a;break;case 4:return e.label++,{value:a[1],done:!1};case 5:e.label++,i=a[1],a=[0];continue;case 7:a=e.ops.pop(),e.trys.pop();continue;default:if(t=e.trys,!(t=t.length>0&&t[t.length-1])&&(a[0]===6||a[0]===2)){e=0;continue}if(a[0]===3&&(!t||a[1]>t[0]&&a[1]<t[3])){e.label=a[1];break}if(a[0]===6&&e.label<t[1]){e.label=t[1],t=a;break}if(t&&e.label<t[2]){e.label=t[2],e.ops.push(a);break}t[2]&&e.ops.pop(),e.trys.pop();continue}a=n.call(r,e)}catch(c){a=[6,c],i=0}finally{o=t=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};function ue(r,n,e){return ae(this,void 0,void 0,function(){var o,i;return se(this,function(t){return o=ge.stringify({ak:r,bucket:n}),i=e+"://api.qiniu.com/v2/query?"+o,[2,m(i,{method:"GET"})]})})}function $(r,n,e){var o=e.url,i=e.id;return o+"/buckets/"+r+"/objects/"+(n!=null?b(n):"~")+"/uploads/"+i}function je(r,n,e,o){var i=o+"/buckets/"+n+"/objects/"+(e!=null?b(e):"~")+"/uploads";return m(i,{method:"POST",headers:O(r)})}function Be(r,n,e,o,i){var t=z(r).bucketName,s=$(t,n,o)+("/"+e),u=re(r);return i.md5&&(u["Content-MD5"]=i.md5),m(s,_(_({},i),{method:"PUT",headers:u}))}function $e(r,n,e,o){var i=z(r).bucketName,t=$(i,n,e);return m(t,_(_({},o),{method:"POST",headers:ie(r)}))}function Ve(r,n,e){var o=z(r).bucketName,i=$(o,n,e);return m(i,{method:"DELETE",headers:O(r)})}function Ge(r,n,e){return m(r,_({method:"POST",body:n},e))}function Ne(r,n){return ae(this,void 0,void 0,function(){var e,o,i,t,s;return se(this,function(u){switch(u.label){case 0:return e=he(r),o=e.upprotocol,e.uphost.length>0?[2,o+"://"+e.uphost[0]]:(i=z(n),[4,ue(i.assessKey,i.bucketName,o)]);case 1:return t=u.sent(),s=t.data.up.acc.main,[2,o+"://"+s[0]]}})})}var q=function(){return q=Object.assign||function(r){for(var n,e=1,o=arguments.length;e<o;e++){n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])}return r},q.apply(this,arguments)},G=function(r,n,e,o){function i(t){return t instanceof e?t:new e(function(s){s(t)})}return new(e||(e=Promise))(function(t,s){function u(c){try{a(o.next(c))}catch(f){s(f)}}function l(c){try{a(o.throw(c))}catch(f){s(f)}}function a(c){c.done?t(c.value):i(c.value).then(u,l)}a((o=o.apply(r,n||[])).next())})},N=function(r,n){var e={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},o,i,t,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(c){return l([a,c])}}function l(a){if(o)throw new TypeError("Generator is already executing.");for(;e;)try{if(o=1,i&&(t=a[0]&2?i.return:a[0]?i.throw||((t=i.return)&&t.call(i),0):i.next)&&!(t=t.call(i,a[1])).done)return t;switch(i=0,t&&(a=[a[0]&2,t.value]),a[0]){case 0:case 1:t=a;break;case 4:return e.label++,{value:a[1],done:!1};case 5:e.label++,i=a[1],a=[0];continue;case 7:a=e.ops.pop(),e.trys.pop();continue;default:if(t=e.trys,!(t=t.length>0&&t[t.length-1])&&(a[0]===6||a[0]===2)){e=0;continue}if(a[0]===3&&(!t||a[1]>t[0]&&a[1]<t[3])){e.label=a[1];break}if(a[0]===6&&e.label<t[1]){e.label=t[1],t=a;break}if(t&&e.label<t[2]){e.label=t[2],e.ops.push(a);break}t[2]&&e.ops.pop(),e.trys.pop();continue}a=n.call(r,e)}catch(c){a=[6,c],i=0}finally{o=t=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},Xe=function(r,n){var e=typeof Symbol=="function"&&r[Symbol.iterator];if(!e)return r;var o=e.call(r),i,t=[],s;try{for(;(n===void 0||n-- >0)&&!(i=o.next()).done;)t.push(i.value)}catch(u){s={error:u}}finally{try{i&&!i.done&&(e=o.return)&&e.call(o)}finally{if(s)throw s.error}}return t},We=function(){for(var r=[],n=0;n<arguments.length;n++)r=r.concat(Xe(arguments[n]));return r},Je=4,ce=[0,502,503,504,599],Ke=We(ce,[612]),Ze=Math.pow(1024,3),le=function(){function r(n,e,o,i){this.hostPool=o,this.logger=i,this.aborted=!1,this.retryCount=0,this.xhrList=[],this.config=n.config,i.info("config inited.",this.config),this.putExtra=q({fname:""},n.putExtra),i.info("putExtra inited.",this.putExtra),this.key=n.key,this.file=n.file,this.token=n.token,this.onData=e.onData,this.onError=e.onError,this.onComplete=e.onComplete;try{var t=z(this.token);this.bucketName=t.bucketName,this.assessKey=t.assessKey}catch(s){i.error("get putPolicy from token failed.",s),this.onError(s)}}return r.prototype.checkAndUpdateUploadHost=function(){return G(this,void 0,void 0,function(){var n;return N(this,function(e){switch(e.label){case 0:return this.logger.info("get available upload host."),[4,this.hostPool.getUp(this.assessKey,this.bucketName,this.config.upprotocol)];case 1:if(n=e.sent(),n==null)throw new p(d.NotAvailableUploadHost,"no available upload host.");return this.uploadHost!=null&&this.uploadHost.host!==n.host?this.logger.warn("host switches from "+this.uploadHost.host+" to "+n.host+"."):this.logger.info("use host "+n.host+"."),this.uploadHost=n,[2]}})})},r.prototype.checkAndUnfreezeHost=function(){this.logger.info("check unfreeze host."),this.uploadHost!=null&&this.uploadHost.isFrozen()&&(this.logger.warn(this.uploadHost.host+" will be unfrozen."),this.uploadHost.unfreeze())},r.prototype.checkAndFreezeHost=function(n){this.logger.info("check freeze host."),n instanceof C&&this.uploadHost!=null&&ce.includes(n.code)&&(this.logger.warn(this.uploadHost.host+" will be temporarily frozen."),this.uploadHost.freeze())},r.prototype.handleError=function(n){this.logger.error(n.message),this.onError(n)},r.prototype.putFile=function(){return G(this,void 0,void 0,function(){var n,e,o,i;return N(this,function(t){switch(t.label){case 0:if(this.aborted=!1,this.putExtra.fname||(this.logger.info("use file.name as fname."),this.putExtra.fname=this.file.name),this.file.size>1e4*Ze)return this.handleError(new p(d.InvalidFile,"file size exceed maximum value 10000G")),[2];if(this.putExtra.customVars&&!ze(this.putExtra.customVars))return this.handleError(new p(d.InvalidCustomVars,"customVars key should start width x:")),[2];if(this.putExtra.metadata&&!Oe(this.putExtra.metadata))return this.handleError(new p(d.InvalidMetadata,"metadata key should start with x-qn-meta-")),[2];t.label=1;case 1:return t.trys.push([1,4,,5]),this.uploadAt=new Date().getTime(),[4,this.checkAndUpdateUploadHost()];case 2:return t.sent(),[4,this.run()];case 3:return n=t.sent(),this.onComplete(n.data),this.checkAndUnfreezeHost(),this.sendLog(n.reqId,200),[2];case 4:return e=t.sent(),this.aborted?(this.logger.warn("upload is aborted."),this.sendLog("",-2),[2]):(this.clear(),this.logger.error(e),e instanceof C&&(this.sendLog(e.reqId,e.code),this.checkAndFreezeHost(e),o=++this.retryCount<=this.config.retryCount,i=Ke.includes(e.code),i&&o)?(this.logger.warn("error auto retry: "+this.retryCount+"/"+this.config.retryCount+"."),this.putFile(),[2]):(this.onError(e),[3,5]));case 5:return[2]}})})},r.prototype.clear=function(){this.xhrList.forEach(function(n){n.onreadystatechange=null,n.abort()}),this.xhrList=[],this.logger.info("cleanup uploading xhr.")},r.prototype.stop=function(){this.logger.info("aborted."),this.clear(),this.aborted=!0},r.prototype.addXhr=function(n){this.xhrList.push(n)},r.prototype.sendLog=function(n,e){var o,i;this.logger.report({code:e,reqId:n,remoteIp:"",upType:"jssdk-h5",size:this.file.size,time:Math.floor(this.uploadAt/1e3),port:qe((o=this.uploadHost)===null||o===void 0?void 0:o.getUrl()),host:He((i=this.uploadHost)===null||i===void 0?void 0:i.getUrl()),bytesSent:this.progress?this.progress.total.loaded:0,duration:Math.floor((new Date().getTime()-this.uploadAt)/1e3)})},r.prototype.getProgressInfoItem=function(n,e,o){return q({size:e,loaded:n,percent:n/e*100},o==null?{}:{fromCache:o})},r}(),Ye=function(){var r=function(n,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,i){o.__proto__=i}||function(o,i){for(var t in i)i.hasOwnProperty(t)&&(o[t]=i[t])},r(n,e)};return function(n,e){r(n,e);function o(){this.constructor=n}n.prototype=e===null?Object.create(e):(o.prototype=e.prototype,new o)}}(),R=function(){return R=Object.assign||function(r){for(var n,e=1,o=arguments.length;e<o;e++){n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])}return r},R.apply(this,arguments)},I=function(r,n,e,o){function i(t){return t instanceof e?t:new e(function(s){s(t)})}return new(e||(e=Promise))(function(t,s){function u(c){try{a(o.next(c))}catch(f){s(f)}}function l(c){try{a(o.throw(c))}catch(f){s(f)}}function a(c){c.done?t(c.value):i(c.value).then(u,l)}a((o=o.apply(r,n||[])).next())})},S=function(r,n){var e={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},o,i,t,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(c){return l([a,c])}}function l(a){if(o)throw new TypeError("Generator is already executing.");for(;e;)try{if(o=1,i&&(t=a[0]&2?i.return:a[0]?i.throw||((t=i.return)&&t.call(i),0):i.next)&&!(t=t.call(i,a[1])).done)return t;switch(i=0,t&&(a=[a[0]&2,t.value]),a[0]){case 0:case 1:t=a;break;case 4:return e.label++,{value:a[1],done:!1};case 5:e.label++,i=a[1],a=[0];continue;case 7:a=e.ops.pop(),e.trys.pop();continue;default:if(t=e.trys,!(t=t.length>0&&t[t.length-1])&&(a[0]===6||a[0]===2)){e=0;continue}if(a[0]===3&&(!t||a[1]>t[0]&&a[1]<t[3])){e.label=a[1];break}if(a[0]===6&&e.label<t[1]){e.label=t[1],t=a;break}if(t&&e.label<t[2]){e.label=t[2],e.ops.push(a);break}t[2]&&e.ops.pop(),e.trys.pop();continue}a=n.call(r,e)}catch(c){a=[6,c],i=0}finally{o=t=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};function Qe(r){var n=/^[1-9]\d*$/;return n.test(String(r))}var et=function(r){Ye(n,r);function n(){return r!==null&&r.apply(this,arguments)||this}return n.prototype.run=function(){return I(this,void 0,void 0,function(){var e,o,i,t,s,u=this;return S(this,function(l){switch(l.label){case 0:if(this.logger.info("start run Resume."),!this.config.chunkSize||!Qe(this.config.chunkSize))throw new p(d.InvalidChunkSize,"chunkSize must be a positive integer");if(this.config.chunkSize>1024)throw new p(d.InvalidChunkSize,"chunkSize maximum value is 1024");return[4,this.initBeforeUploadChunks()];case 1:l.sent(),e=new ye(function(a){return I(u,void 0,void 0,function(){return S(this,function(c){switch(c.label){case 0:if(this.aborted)throw e.abort(),new Error("pool is aborted");return[4,this.uploadChunk(a)];case 1:return c.sent(),[2]}})})},this.config.concurrentRequestLimit),o=null,i=this.getLocalKey(),t=this.chunks.map(function(a,c){return e.enqueue({chunk:a,index:c})}),l.label=2;case 2:return l.trys.push([2,5,,6]),[4,Promise.all(t)];case 3:return l.sent(),[4,this.mkFileReq()];case 4:return o=l.sent(),[3,6];case 5:throw s=l.sent(),s instanceof C&&(s.code===612||s.code===400)&&M(i,this.logger),s;case 6:return M(i,this.logger),[2,o]}})})},n.prototype.uploadChunk=function(e){return I(this,void 0,void 0,function(){var o,i,t,s,u,l,a,c,f,h=this;return S(this,function(v){switch(v.label){case 0:return o=e.index,i=e.chunk,t=this.cachedUploadedList[o],this.logger.info("upload part "+o+", cache:",t),s=this.config.checkByMD5,u=function(){h.usedCacheList[o]=!0,h.updateChunkProgress(i.size,o),h.uploadedList[o]=t,h.updateLocalCache()},t&&!s?(u(),[2]):[4,Ae(i)];case 1:return l=v.sent(),this.logger.info("computed part md5.",l),t&&l===t.md5?(u(),[2]):(this.usedCacheList[o]=!1,a=function(g){h.updateChunkProgress(g.loaded,o)},c={body:i,md5:this.config.checkByServer?l:void 0,onProgress:a,onCreate:function(g){return h.addXhr(g)}},this.logger.info("part "+o+" start uploading."),[4,Be(this.token,this.key,e.index+1,this.getUploadInfo(),c)]);case 2:return f=v.sent(),this.logger.info("part "+o+" upload completed."),a({loaded:i.size,total:i.size}),this.uploadedList[o]={etag:f.data.etag,md5:f.data.md5,size:i.size},this.updateLocalCache(),[2]}})})},n.prototype.mkFileReq=function(){return I(this,void 0,void 0,function(){var e,o,i=this;return S(this,function(t){switch(t.label){case 0:return e=R(R(R({parts:this.uploadedList.map(function(s,u){return{etag:s.etag,partNumber:u+1}}),fname:this.putExtra.fname},this.putExtra.mimeType&&{mimeType:this.putExtra.mimeType}),this.putExtra.customVars&&{customVars:this.putExtra.customVars}),this.putExtra.metadata&&{metadata:this.putExtra.metadata}),this.logger.info("parts upload completed, make file.",e),[4,$e(this.token,this.key,this.getUploadInfo(),{onCreate:function(s){return i.addXhr(s)},body:JSON.stringify(e)})];case 1:return o=t.sent(),this.logger.info("finish Resume Progress."),this.updateMkFileProgress(1),[2,o]}})})},n.prototype.initBeforeUploadChunks=function(){return I(this,void 0,void 0,function(){var e,o,i;return S(this,function(t){switch(t.label){case 0:return this.uploadedList=[],this.usedCacheList=[],e=Le(this.getLocalKey(),this.logger),e?[3,2]:(this.logger.info("init upload parts from api."),[4,je(this.token,this.bucketName,this.key,this.uploadHost.getUrl())]);case 1:return o=t.sent(),this.logger.info("initd upload parts of id: "+o.data.uploadId+"."),this.uploadId=o.data.uploadId,this.cachedUploadedList=[],[3,3];case 2:i=["resume upload parts from local cache,","total "+e.data.length+" part,","id is "+e.id+"."],this.logger.info(i.join(" ")),this.cachedUploadedList=e.data,this.uploadId=e.id,t.label=3;case 3:return this.chunks=Re(this.file,this.config.chunkSize),this.loaded={mkFileProgress:0,chunks:this.chunks.map(function(s){return 0})},this.notifyResumeProgress(),[2]}})})},n.prototype.getUploadInfo=function(){return{id:this.uploadId,url:this.uploadHost.getUrl()}},n.prototype.getLocalKey=function(){return Pe(this.file.name,this.key,this.file.size)},n.prototype.updateLocalCache=function(){Ee(this.getLocalKey(),{id:this.uploadId,data:this.uploadedList},this.logger)},n.prototype.updateChunkProgress=function(e,o){this.loaded.chunks[o]=e,this.notifyResumeProgress()},n.prototype.updateMkFileProgress=function(e){this.loaded.mkFileProgress=e,this.notifyResumeProgress()},n.prototype.notifyResumeProgress=function(){var e=this;this.progress={total:this.getProgressInfoItem(Fe(this.loaded.chunks)+this.loaded.mkFileProgress,this.file.size+1),chunks:this.chunks.map(function(o,i){var t=e.usedCacheList[i];return e.getProgressInfoItem(e.loaded.chunks[i],o.size,t)}),uploadInfo:{id:this.uploadId,url:this.uploadHost.getUrl()}},this.onData(this.progress)},n}(le),X=function(r,n,e,o){function i(t){return t instanceof e?t:new e(function(s){s(t)})}return new(e||(e=Promise))(function(t,s){function u(c){try{a(o.next(c))}catch(f){s(f)}}function l(c){try{a(o.throw(c))}catch(f){s(f)}}function a(c){c.done?t(c.value):i(c.value).then(u,l)}a((o=o.apply(r,n||[])).next())})},W=function(r,n){var e={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},o,i,t,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(c){return l([a,c])}}function l(a){if(o)throw new TypeError("Generator is already executing.");for(;e;)try{if(o=1,i&&(t=a[0]&2?i.return:a[0]?i.throw||((t=i.return)&&t.call(i),0):i.next)&&!(t=t.call(i,a[1])).done)return t;switch(i=0,t&&(a=[a[0]&2,t.value]),a[0]){case 0:case 1:t=a;break;case 4:return e.label++,{value:a[1],done:!1};case 5:e.label++,i=a[1],a=[0];continue;case 7:a=e.ops.pop(),e.trys.pop();continue;default:if(t=e.trys,!(t=t.length>0&&t[t.length-1])&&(a[0]===6||a[0]===2)){e=0;continue}if(a[0]===3&&(!t||a[1]>t[0]&&a[1]<t[3])){e.label=a[1];break}if(a[0]===6&&e.label<t[1]){e.label=t[1],t=a;break}if(t&&e.label<t[2]){e.label=t[2],e.ops.push(a);break}t[2]&&e.ops.pop(),e.trys.pop();continue}a=n.call(r,e)}catch(c){a=[6,c],i=0}finally{o=t=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},tt=function(){function r(){this.crc=-1,this.table=this.makeTable()}return r.prototype.makeTable=function(){for(var n=new Array,e=0;e<256;e++){for(var o=e,i=0;i<8;i++)o&1?o=o>>>1^3988292384:o>>>=1;n[e]=o}return n},r.prototype.append=function(n){for(var e=this.crc,o=0;o<n.byteLength;o++)e=e>>>8^this.table[(e^n[o])&255];this.crc=e},r.prototype.compute=function(){return(this.crc^-1)>>>0},r.prototype.readAsUint8Array=function(n){return X(this,void 0,void 0,function(){var e;return W(this,function(o){switch(o.label){case 0:return typeof n.arrayBuffer!="function"?[3,2]:(e=Uint8Array.bind,[4,n.arrayBuffer()]);case 1:return[2,new(e.apply(Uint8Array,[void 0,o.sent()]))];case 2:return[2,new Promise(function(i,t){var s=new FileReader;s.onload=function(){if(s.result==null){t();return}if(typeof s.result=="string"){t();return}i(new Uint8Array(s.result))},s.readAsArrayBuffer(n)})]}})})},r.prototype.file=function(n){return X(this,void 0,void 0,function(){var e,o,i,t,s,u;return W(this,function(l){switch(l.label){case 0:return n.size<=x?(e=this.append,[4,this.readAsUint8Array(n)]):[3,2];case 1:return e.apply(this,[l.sent()]),[2,this.compute()];case 2:o=Math.ceil(n.size/x),i=0,l.label=3;case 3:return i<o?(t=i*x,s=i===o-1?n.size:t+x,[4,this.readAsUint8Array(n.slice(t,s))]):[3,6];case 4:u=l.sent(),this.append(new Uint8Array(u)),l.label=5;case 5:return i++,[3,3];case 6:return[2,this.compute()]}})})},r.file=function(n){var e=new r;return e.file(n)},r}(),nt=function(){var r=function(n,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,i){o.__proto__=i}||function(o,i){for(var t in i)i.hasOwnProperty(t)&&(o[t]=i[t])},r(n,e)};return function(n,e){r(n,e);function o(){this.constructor=n}n.prototype=e===null?Object.create(e):(o.prototype=e.prototype,new o)}}(),rt=function(r,n,e,o){function i(t){return t instanceof e?t:new e(function(s){s(t)})}return new(e||(e=Promise))(function(t,s){function u(c){try{a(o.next(c))}catch(f){s(f)}}function l(c){try{a(o.throw(c))}catch(f){s(f)}}function a(c){c.done?t(c.value):i(c.value).then(u,l)}a((o=o.apply(r,n||[])).next())})},it=function(r,n){var e={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},o,i,t,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(c){return l([a,c])}}function l(a){if(o)throw new TypeError("Generator is already executing.");for(;e;)try{if(o=1,i&&(t=a[0]&2?i.return:a[0]?i.throw||((t=i.return)&&t.call(i),0):i.next)&&!(t=t.call(i,a[1])).done)return t;switch(i=0,t&&(a=[a[0]&2,t.value]),a[0]){case 0:case 1:t=a;break;case 4:return e.label++,{value:a[1],done:!1};case 5:e.label++,i=a[1],a=[0];continue;case 7:a=e.ops.pop(),e.trys.pop();continue;default:if(t=e.trys,!(t=t.length>0&&t[t.length-1])&&(a[0]===6||a[0]===2)){e=0;continue}if(a[0]===3&&(!t||a[1]>t[0]&&a[1]<t[3])){e.label=a[1];break}if(a[0]===6&&e.label<t[1]){e.label=t[1],t=a;break}if(t&&e.label<t[2]){e.label=t[2],e.ops.push(a);break}t[2]&&e.ops.pop(),e.trys.pop();continue}a=n.call(r,e)}catch(c){a=[6,c],i=0}finally{o=t=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},J=function(r){nt(n,r);function n(){return r!==null&&r.apply(this,arguments)||this}return n.prototype.run=function(){return rt(this,void 0,void 0,function(){var e,o,i,t,s,u=this;return it(this,function(l){switch(l.label){case 0:return this.logger.info("start run Direct."),e=new FormData,e.append("file",this.file),e.append("token",this.token),this.key!=null&&e.append("key",this.key),e.append("fname",this.putExtra.fname),this.config.checkByServer?[4,tt.file(this.file)]:[3,2];case 1:o=l.sent(),e.append("crc32",o.toString()),l.label=2;case 2:return this.putExtra.customVars&&(this.logger.info("init customVars."),i=this.putExtra.customVars,Object.keys(i).forEach(function(a){return e.append(a,i[a].toString())}),this.logger.info("customVars inited.")),this.putExtra.metadata&&(this.logger.info("init metadata."),t=this.putExtra.metadata,Object.keys(t).forEach(function(a){return e.append(a,t[a].toString())})),this.logger.info("formData inited."),[4,Ge(this.uploadHost.getUrl(),e,{onProgress:function(a){u.updateDirectProgress(a.loaded,a.total)},onCreate:function(a){return u.addXhr(a)}})];case 3:return s=l.sent(),this.logger.info("Direct progress finish."),this.finishDirectProgress(),[2,s]}})})},n.prototype.updateDirectProgress=function(e,o){this.progress={total:this.getProgressInfoItem(e,o+1)},this.onData(this.progress)},n.prototype.finishDirectProgress=function(){if(!this.progress){this.logger.warn("progress is null."),this.progress={total:this.getProgressInfoItem(this.file.size,this.file.size)},this.onData(this.progress);return}var e=this.progress.total;this.progress={total:this.getProgressInfoItem(e.loaded+1,e.size)},this.onData(this.progress)},n}(le);function fe(r,n,e){e===void 0&&(e=3);var o=oe();o.open("POST","https://uplog.qbox.me/log/3"),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.setRequestHeader("Authorization",O(r).Authorization),o.onreadystatechange=function(){o.readyState===4&&o.status!==200&&e>0&&fe(r,n,e-1)};var i=[n.code||"",n.reqId||"",n.host||"",n.remoteIp||"",n.port||"",n.duration||"",n.time||"",n.bytesSent||"",n.upType||"",n.size||""].join(",");o.send(i)}var ot=function(r,n){var e=typeof Symbol=="function"&&r[Symbol.iterator];if(!e)return r;var o=e.call(r),i,t=[],s;try{for(;(n===void 0||n-- >0)&&!(i=o.next()).done;)t.push(i.value)}catch(u){s={error:u}}finally{try{i&&!i.done&&(e=o.return)&&e.call(o)}finally{if(s)throw s.error}}return t},H=function(){for(var r=[],n=0;n<arguments.length;n++)r=r.concat(ot(arguments[n]));return r},at=function(){function r(n,e,o,i){e===void 0&&(e=!0),o===void 0&&(o="OFF"),i===void 0&&(i="UPLOAD"),this.token=n,this.disableReport=e,this.level=o,this.prefix=i,this.id=++r.id}return r.prototype.getPrintPrefix=function(n){return"Qiniu-JS-SDK ["+n+"]["+this.prefix+"#"+this.id+"]:"},r.prototype.report=function(n,e){if(!this.disableReport)try{fe(this.token,n,e)}catch(o){this.warn(o)}},r.prototype.info=function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var o=["INFO"];o.includes(this.level)&&console.log.apply(console,H([this.getPrintPrefix("INFO")],n))},r.prototype.warn=function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var o=["INFO","WARN"];o.includes(this.level)&&console.warn.apply(console,H([this.getPrintPrefix("WARN")],n))},r.prototype.error=function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var o=["INFO","WARN","ERROR"];o.includes(this.level)&&console.error.apply(console,H([this.getPrintPrefix("ERROR")],n))},r.id=0,r}(),K=function(r,n,e,o){function i(t){return t instanceof e?t:new e(function(s){s(t)})}return new(e||(e=Promise))(function(t,s){function u(c){try{a(o.next(c))}catch(f){s(f)}}function l(c){try{a(o.throw(c))}catch(f){s(f)}}function a(c){c.done?t(c.value):i(c.value).then(u,l)}a((o=o.apply(r,n||[])).next())})},Z=function(r,n){var e={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},o,i,t,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(c){return l([a,c])}}function l(a){if(o)throw new TypeError("Generator is already executing.");for(;e;)try{if(o=1,i&&(t=a[0]&2?i.return:a[0]?i.throw||((t=i.return)&&t.call(i),0):i.next)&&!(t=t.call(i,a[1])).done)return t;switch(i=0,t&&(a=[a[0]&2,t.value]),a[0]){case 0:case 1:t=a;break;case 4:return e.label++,{value:a[1],done:!1};case 5:e.label++,i=a[1],a=[0];continue;case 7:a=e.ops.pop(),e.trys.pop();continue;default:if(t=e.trys,!(t=t.length>0&&t[t.length-1])&&(a[0]===6||a[0]===2)){e=0;continue}if(a[0]===3&&(!t||a[1]>t[0]&&a[1]<t[3])){e.label=a[1];break}if(a[0]===6&&e.label<t[1]){e.label=t[1],t=a;break}if(t&&e.label<t[2]){e.label=t[2],e.ops.push(a);break}t[2]&&e.ops.pop(),e.trys.pop();continue}a=n.call(r,e)}catch(c){a=[6,c],i=0}finally{o=t=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},st=function(r,n){var e=typeof Symbol=="function"&&r[Symbol.iterator];if(!e)return r;var o=e.call(r),i,t=[],s;try{for(;(n===void 0||n-- >0)&&!(i=o.next()).done;)t.push(i.value)}catch(u){s={error:u}}finally{try{i&&!i.done&&(e=o.return)&&e.call(o)}finally{if(s)throw s.error}}return t},ut=function(){for(var r=[],n=0;n<arguments.length;n++)r=r.concat(st(arguments[n]));return r},A=new Map,ct=function(){function r(n,e){this.host=n,this.protocol=e}return r.prototype.isFrozen=function(){var n=new Date().getTime(),e=A.get(this.host);return e!=null&&e>=n},r.prototype.freeze=function(n){n===void 0&&(n=20);var e=new Date().getTime()+n*1e3;A.set(this.host,e)},r.prototype.unfreeze=function(){A.delete(this.host)},r.prototype.getUrl=function(){return this.protocol+"://"+this.host},r.prototype.getUnfreezeTime=function(){return A.get(this.host)},r}(),lt=function(){function r(n){n===void 0&&(n=[]),this.initHosts=n,this.cachedHostsMap=new Map}return r.prototype.register=function(n,e,o,i){this.cachedHostsMap.set(n+"@"+e,o.map(function(t){return new ct(t,i)}))},r.prototype.refresh=function(n,e,o){var i,t,s,u;return K(this,void 0,void 0,function(){var l,a,c;return Z(this,function(f){switch(f.label){case 0:return l=this.cachedHostsMap.get(n+"@"+e)||[],l.length>0?[2]:this.initHosts.length>0?(this.register(n,e,this.initHosts,o),[2]):[4,ue(n,e,o)];case 1:return a=f.sent(),(a==null?void 0:a.data)!=null&&(c=ut(((t=(i=a.data.up)===null||i===void 0?void 0:i.acc)===null||t===void 0?void 0:t.main)||[],((u=(s=a.data.up)===null||s===void 0?void 0:s.acc)===null||u===void 0?void 0:u.backup)||[]),this.register(n,e,c,o)),[2]}})})},r.prototype.getUp=function(n,e,o){return K(this,void 0,void 0,function(){var i,t,s;return Z(this,function(u){switch(u.label){case 0:return[4,this.refresh(n,e,o)];case 1:return u.sent(),i=this.cachedHostsMap.get(n+"@"+e)||[],i.length===0?[2,null]:(t=i.filter(function(l){return!l.isFrozen()}),t.length>0?[2,t[0]]:(s=i.slice().sort(function(l,a){return(l.getUnfreezeTime()||0)-(a.getUnfreezeTime()||0)}),[2,s[0]]))}})})},r}();function ft(r,n,e,o){return r.config&&r.config.forceDirect?(o.info("ues forceDirect mode."),new J(r,n,e,o)):r.file.size>4*x?(o.info("file size over 4M, use Resume."),new et(r,n,e,o)):(o.info("file size less or equal than 4M, use Direct."),new J(r,n,e,o))}function ht(r,n,e,o,i){var t=new at(e,i==null?void 0:i.disableStatisticsReport,i==null?void 0:i.debugLogLevel,r.name),s={file:r,key:n,token:e,putExtra:o,config:he(i,t)},u=new lt(s.config.uphost);return new _e(function(l){var a=ft(s,{onData:function(c){return l.next(c)},onError:function(c){return l.error(c)},onComplete:function(c){return l.complete(c)}},u,t);return a.putFile(),a.stop.bind(a)})}var k=function(){return k=Object.assign||function(r){for(var n,e=1,o=arguments.length;e<o;e++){n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])}return r},k.apply(this,arguments)},dt=function(r,n){var e={};for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&n.indexOf(o)<0&&(e[o]=r[o]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,o=Object.getOwnPropertySymbols(r);i<o.length;i++)n.indexOf(o[i])<0&&Object.prototype.propertyIsEnumerable.call(r,o[i])&&(e[o[i]]=r[o[i]]);return e},pt=function(r,n){var e=typeof Symbol=="function"&&r[Symbol.iterator];if(!e)return r;var o=e.call(r),i,t=[],s;try{for(;(n===void 0||n-- >0)&&!(i=o.next()).done;)t.push(i.value)}catch(u){s={error:u}}finally{try{i&&!i.done&&(e=o.return)&&e.call(o)}finally{if(s)throw s.error}}return t},D=function(){for(var r=[],n=0;n<arguments.length;n++)r=r.concat(pt(arguments[n]));return r};function he(r,n){var e=k({},r),o=e.upprotocol,i=e.uphost,t=dt(e,["upprotocol","uphost"]),s=k({uphost:[],retryCount:3,checkByMD5:!1,forceDirect:!1,useCdnDomain:!0,checkByServer:!1,concurrentRequestLimit:3,chunkSize:Je,upprotocol:"https",debugLogLevel:"OFF",disableStatisticsReport:!1},t);o&&(s.upprotocol=o.replace(/:$/,""));var u=[];if(n&&(r==null?void 0:r.uphost)!=null&&(r==null?void 0:r.region)!=null&&n.warn("do not use both the uphost and region config."),i)Array.isArray(i)?u.push.apply(u,D(i)):u.push(i);else if(s!=null&&s.region){var l=Me[s==null?void 0:s.region];s.useCdnDomain?u.push.apply(u,D(l.cdnUphost)):u.push.apply(u,D(l.srcUphost))}return k(k({},s),{uphost:u.filter(Boolean)})}var j=function(){return j=Object.assign||function(r){for(var n,e=1,o=arguments.length;e<o;e++){n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])}return r},j.apply(this,arguments)},Y=function(r,n,e,o){function i(t){return t instanceof e?t:new e(function(s){s(t)})}return new(e||(e=Promise))(function(t,s){function u(c){try{a(o.next(c))}catch(f){s(f)}}function l(c){try{a(o.throw(c))}catch(f){s(f)}}function a(c){c.done?t(c.value):i(c.value).then(u,l)}a((o=o.apply(r,[])).next())})},Q=function(r,n){var e={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},o,i,t,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(c){return l([a,c])}}function l(a){if(o)throw new TypeError("Generator is already executing.");for(;e;)try{if(o=1,i&&(t=a[0]&2?i.return:a[0]?i.throw||((t=i.return)&&t.call(i),0):i.next)&&!(t=t.call(i,a[1])).done)return t;switch(i=0,t&&(a=[a[0]&2,t.value]),a[0]){case 0:case 1:t=a;break;case 4:return e.label++,{value:a[1],done:!1};case 5:e.label++,i=a[1],a=[0];continue;case 7:a=e.ops.pop(),e.trys.pop();continue;default:if(t=e.trys,!(t=t.length>0&&t[t.length-1])&&(a[0]===6||a[0]===2)){e=0;continue}if(a[0]===3&&(!t||a[1]>t[0]&&a[1]<t[3])){e.label=a[1];break}if(a[0]===6&&e.label<t[1]){e.label=t[1],t=a;break}if(t&&e.label<t[2]){e.label=t[2],e.ops.push(a);break}t[2]&&e.ops.pop(),e.trys.pop();continue}a=n.call(r,e)}catch(c){a=[6,c],i=0}finally{o=t=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},B={PNG:"image/png",JPEG:"image/jpeg",WEBP:"image/webp",BMP:"image/bmp"},vt=4,gt=Math.log(2),yt=Object.keys(B).map(function(r){return B[r]}),mt=B.JPEG;function wt(r){return yt.includes(r)}var bt=function(){function r(n,e){this.file=n,this.config=e,this.config=j({quality:.92,noCompressIfLarger:!1},this.config)}return r.prototype.process=function(){return Y(this,void 0,void 0,function(){var n,e,o,i,t,s;return Q(this,function(u){switch(u.label){case 0:if(this.outputType=this.file.type,n={},!wt(this.file.type))throw new p(d.UnsupportedFileType,"unsupported file type: "+this.file.type);return[4,this.getOriginImage()];case 1:return e=u.sent(),[4,this.getCanvas(e)];case 2:return o=u.sent(),i=1,this.config.maxWidth&&(i=Math.min(1,this.config.maxWidth/o.width)),this.config.maxHeight&&(i=Math.min(1,i,this.config.maxHeight/o.height)),n.width=o.width,n.height=o.height,[4,this.doScale(o,i)];case 3:return t=u.sent(),s=this.toBlob(t),s.size>this.file.size&&this.config.noCompressIfLarger?[2,{dist:this.file,width:n.width,height:n.height}]:[2,{dist:s,width:t.width,height:t.height}]}})})},r.prototype.clear=function(n,e,o){this.outputType===mt?(n.fillStyle="#fff",n.fillRect(0,0,e,o)):n.clearRect(0,0,e,o)},r.prototype.getOriginImage=function(){var n=this;return new Promise(function(e,o){var i=De(n.file),t=new Image;t.onload=function(){e(t)},t.onerror=function(){o("image load error")},t.src=i})},r.prototype.getCanvas=function(n){var e=this;return new Promise(function(o,i){var t=document.createElement("canvas"),s=t.getContext("2d");if(!s){i(new p(d.GetCanvasContextFailed,"context is null"));return}var u=n.width,l=n.height;t.height=l,t.width=u,e.clear(s,u,l),s.drawImage(n,0,0),o(t)})},r.prototype.doScale=function(n,e){return Y(this,void 0,void 0,function(){var o,i,t,s,u,l,a,c,f,h,v,g,E,P,L,V;return Q(this,function(St){if(e===1)return[2,n];if(o=n.getContext("2d"),i=Math.min(vt,Math.ceil(1/e/gt)),t=Math.pow(e,1/i),s=document.createElement("canvas"),u=s.getContext("2d"),l=n.width,a=n.height,c=l,f=a,s.width=l,s.height=a,!u||!o)throw new p(d.GetCanvasContextFailed,"mctx or sctx can't be null");for(g=0;g<i;g++)E=l*t|0,P=a*t|0,g===i-1&&(E=c*e,P=f*e),g%2===0?(h=n,v=u):(h=s,v=o),this.clear(v,l,a),v.drawImage(h,0,0,l,a,0,0,E,P),l=E,a=P;return L=h===n?s:n,V=v.getImageData(0,0,l,a),L.width=l,L.height=a,v.putImageData(V,0,0),[2,L]})})},r.prototype.toBlob=function(n){var e=n.toDataURL(this.outputType,this.config.quality),o=atob(e.split(",")[1]).split("").map(function(t){return t.charCodeAt(0)}),i=new Blob([new Uint8Array(o)],{type:this.outputType});return i},r}(),_t=function(r,n){return new bt(r,n).process()};function F(r,n){return r=encodeURIComponent(r),n.slice(n.length-1)!=="/"&&(n+="/"),n+r}function xt(r,n,e){if(!/^\d$/.test(String(r.mode)))throw"mode should be number in imageView2";var o=r.mode,i=r.w,t=r.h,s=r.q,u=r.format;if(!i&&!t)throw"param w and h is empty in imageView2";var l="imageView2/"+encodeURIComponent(o);return l+=i?"/w/"+encodeURIComponent(i):"",l+=t?"/h/"+encodeURIComponent(t):"",l+=s?"/q/"+encodeURIComponent(s):"",l+=u?"/format/"+encodeURIComponent(u):"",l}function de(r,n,e){var o=r["auto-orient"],i=r.thumbnail,t=r.strip,s=r.gravity,u=r.crop,l=r.quality,a=r.rotate,c=r.format,f=r.blur,h="imageMogr2";return h+=o?"/auto-orient":"",h+=i?"/thumbnail/"+encodeURIComponent(i):"",h+=t?"/strip":"",h+=s?"/gravity/"+encodeURIComponent(s):"",h+=l?"/quality/"+encodeURIComponent(l):"",h+=u?"/crop/"+encodeURIComponent(u):"",h+=a?"/rotate/"+encodeURIComponent(a):"",h+=c?"/format/"+encodeURIComponent(c):"",h+=f?"/blur/"+encodeURIComponent(f):"",n&&e&&(h=F(n,e)+"?"+h),h}function pe(r,n,e){var o=r.mode;if(!o)throw"mode can't be empty in watermark";var i="watermark/"+o;if(o!==1&&o!==2)throw"mode is wrong";if(o===1){var t=r.image;if(!t)throw"image can't be empty in watermark";i+=t?"/image/"+b(t):""}if(o===2){var s=r.text,u=r.font,l=r.fontsize,a=r.fill;if(!s)throw"text can't be empty in watermark";i+=s?"/text/"+b(s):"",i+=u?"/font/"+b(u):"",i+=l?"/fontsize/"+l:"",i+=a?"/fill/"+b(a):""}var c=r.dissolve,f=r.gravity,h=r.dx,v=r.dy;return i+=c?"/dissolve/"+encodeURIComponent(c):"",i+=f?"/gravity/"+encodeURIComponent(f):"",i+=h?"/dx/"+encodeURIComponent(h):"",i+=v?"/dy/"+encodeURIComponent(v):"",n&&e&&(i=F(n,e)+"?"+i),i}function kt(r,n){var e=F(r,n)+"?imageInfo";return m(e,{method:"GET"})}function Ct(r,n){var e=F(r,n)+"?exif";return m(e,{method:"GET"})}function It(r,n,e){var o=Object.prototype.toString.call(r)==="[object Array]",i,t=!1,s="";if(o){for(var u=0,l=r.length;u<l;u++){if(i=r[u],!i.fop)throw"fop can't be empty in pipeline";switch(i.fop){case"watermark":s+=pe(i)+"|";break;case"imageView2":s+=xt(i)+"|";break;case"imageMogr2":s+=de(i)+"|";break;default:t=!0;break}if(t)throw"fop is wrong in pipeline"}if(n&&e){s=F(n,e)+"?"+s;var a=s.length;s.slice(a-1)==="|"&&(s=s.slice(0,a-1))}return s}throw"pipeline's first param should be array"}const Ot=Object.freeze(Object.defineProperty({__proto__:null,QiniuError:p,get QiniuErrorName(){return d},QiniuNetworkError:te,QiniuRequestError:C,compressImage:_t,deleteUploadedChunks:Ve,exif:Ct,getHeadersForChunkUpload:re,getHeadersForMkFile:ie,getUploadUrl:Ne,imageInfo:kt,imageMogr2:de,pipeline:It,region:w,upload:ht,urlSafeBase64Decode:ne,urlSafeBase64Encode:b,watermark:pe},Symbol.toStringTag,{value:"Module"}));export{Ot as q,ht as u};
